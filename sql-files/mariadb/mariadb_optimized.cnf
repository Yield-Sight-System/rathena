# ============================================================================
# MARIADB OPTIMIZED CONFIGURATION FOR RATHENA GAME SERVER
# ============================================================================
# Version: 1.0
# Target: MariaDB 10.11 LTS / 11.2 Stable
# Date: 2026-01-06
# 
# Optimized for:
# - Game server workload (500+ concurrent players)
# - High-concurrency transactional operations
# - SSD storage
# - 8GB RAM recommended (minimum 4GB)
# - InnoDB primary storage engine
# - Aria for logging tables
#
# IMPORTANT: Adjust innodb_buffer_pool_size based on your server RAM:
# - For 4GB RAM server: set to 2G
# - For 8GB RAM server: set to 4-6G
# - For 16GB RAM server: set to 10-12G
# - Rule of thumb: 50-80% of total RAM for dedicated database server
#
# Installation:
# 1. Backup existing configuration: cp /etc/my.cnf /etc/my.cnf.backup
# 2. Copy this file: cp mariadb_optimized.cnf /etc/my.cnf
# 3. Verify syntax: mysqld --help --verbose
# 4. Restart MariaDB: systemctl restart mariadb
# 5. Verify settings: mysql -e "SHOW VARIABLES LIKE '%innodb%';"
# ============================================================================

[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
default-character-set = utf8mb4

[mysql]
default-character-set = utf8mb4

[mysqld]
# ============================================================================
# BASIC SERVER SETTINGS
# ============================================================================

# Server identification
server-id = 1
port = 3306
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid

# Data directory (adjust to your setup)
datadir = /var/lib/mysql
tmpdir = /tmp

# User to run MySQL as
user = mysql

# Skip DNS hostname lookups (faster connections)
skip-name-resolve = 1

# Skip symbolic links
skip-symbolic-links = 1

# ============================================================================
# CHARACTER SET AND COLLATION
# ============================================================================

# Use UTF-8mb4 for full unicode support (including emojis, special characters)
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# Client connection character set
character-set-client-handshake = FALSE
init_connect = 'SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci'

# ============================================================================
# SQL MODE
# ============================================================================

# Relaxed SQL mode for compatibility with rAthena code
# Avoids strict mode issues while maintaining reasonable data validation
sql_mode = NO_ENGINE_SUBSTITUTION,NO_AUTO_CREATE_USER

# ============================================================================
# CONNECTION HANDLING
# ============================================================================

# Maximum simultaneous connections (all game servers + web + admin)
# Adjust based on: login-server (5) + char-server (10) + map-servers (20 each)
max_connections = 500

# Connection request queue size (during bursts)
back_log = 500

# Maximum login attempts before temporary host blocking
# High value prevents legitimate servers from being blocked
max_connect_errors = 10000

# Connection timeout in seconds
connect_timeout = 10

# Wait timeout for idle connections (8 hours)
# Long timeout prevents game server reconnection overhead
wait_timeout = 28800
interactive_timeout = 28800

# Maximum allowed packet size (for large queries, guild emblems, etc.)
max_allowed_packet = 64M

# Network timeouts
net_read_timeout = 30
net_write_timeout = 60

# ============================================================================
# THREAD HANDLING AND POOLING
# ============================================================================

# Use thread pool for better performance under high concurrency
# This is critical for game servers with many simultaneous player actions
thread_handling = pool-of-threads

# Thread pool size (typically set to number of CPU cores)
# For 4-core CPU: 4, for 8-core: 8, for 16-core: 16
thread_pool_size = 4

# Maximum threads in thread pool
thread_pool_max_threads = 500

# Milliseconds before creating new thread for stalled group
thread_pool_stall_limit = 500

# Seconds before idle thread exits
thread_pool_idle_timeout = 60

# Thread oversubscription factor (threads per group)
thread_pool_oversubscribe = 3

# Thread cache for connection reuse (when not using thread pool)
thread_cache_size = 100

# ============================================================================
# INNODB STORAGE ENGINE CONFIGURATION
# ============================================================================
# InnoDB is the primary engine for ACID-compliant transactional tables
# (char, inventory, storage, guild, login, etc.)
# ============================================================================

# ----------------------------------------------------------------------------
# InnoDB Buffer Pool (Most Important Setting!)
# ----------------------------------------------------------------------------

# Buffer pool size: ADJUST THIS BASED ON YOUR RAM!
# This is the #1 performance setting for InnoDB
# Caches data and indexes in memory
# 
# Recommended values:
# - 4GB RAM server: innodb_buffer_pool_size = 2G
# - 8GB RAM server: innodb_buffer_pool_size = 4G-6G
# - 16GB RAM server: innodb_buffer_pool_size = 10G-12G
# - 32GB RAM server: innodb_buffer_pool_size = 24G-26G
innodb_buffer_pool_size = 4G

# Number of buffer pool instances (1 per GB, max 64)
# Reduces contention for buffer pool mutex
# Formula: buffer_pool_size_in_GB, but at least 2
innodb_buffer_pool_instances = 4

# Buffer pool chunk size (must be buffer_pool_size / instances / 128)
# Allows online buffer pool resizing
innodb_buffer_pool_chunk_size = 128M

# Buffer pool management
# Keep frequently accessed data "hot" in buffer pool
innodb_old_blocks_time = 1000

# Old blocks percentage (LRU algorithm tuning)
innodb_old_blocks_pct = 37

# Save buffer pool state on shutdown, restore on startup
# Dramatically reduces warmup time after restart
innodb_buffer_pool_dump_at_shutdown = 1
innodb_buffer_pool_load_at_startup = 1
innodb_buffer_pool_dump_pct = 25

# ----------------------------------------------------------------------------
# InnoDB Redo Logs
# ----------------------------------------------------------------------------

# Redo log file size (larger = fewer checkpoints, better performance)
# 512MB provides good balance between performance and recovery time
innodb_log_file_size = 512M

# Number of redo log files (2 is standard)
innodb_log_files_in_group = 2

# Redo log buffer size (buffer before flushing to disk)
innodb_log_buffer_size = 16M

# Flush behavior (CRITICAL FOR DATA SAFETY)
# 0 = Flush once per second (fastest, can lose 1 sec of data on OS crash)
# 1 = Flush on every commit (safest, full ACID, slightly slower)
# 2 = Write on commit, flush once per second (balanced, safe from MySQL crash)
# 
# RECOMMENDATION: Use 1 for production, 2 for testing/development
innodb_flush_log_at_trx_commit = 1

# Flush method (O_DIRECT skips OS cache, best for SSD)
# Options: O_DIRECT (SSD), O_DSYNC (HDD), fsync (default)
innodb_flush_method = O_DIRECT

# ----------------------------------------------------------------------------
# InnoDB I/O Configuration (SSD Optimized)
# ----------------------------------------------------------------------------

# I/O capacity (IOPS - adjust based on your storage)
# SSD: 2000-20000, HDD: 100-300
innodb_io_capacity = 2000

# Maximum I/O capacity for background tasks (checkpoints, flushing)
innodb_io_capacity_max = 4000

# Flush neighbors (0 for SSD, 1 for HDD)
# SSD has fast random I/O, no benefit from flushing adjacent pages
innodb_flush_neighbors = 0

# Number of background read threads
innodb_read_io_threads = 8

# Number of background write threads
innodb_write_io_threads = 8

# ----------------------------------------------------------------------------
# InnoDB Concurrency and Locking
# ----------------------------------------------------------------------------

# Thread concurrency (0 = unlimited, let InnoDB manage)
innodb_thread_concurrency = 0

# Lock wait timeout in seconds (fail fast to avoid deadlocks)
# Game servers should retry rather than wait
innodb_lock_wait_timeout = 5

# Deadlock detection (1 = enabled, catches circular waits)
innodb_deadlock_detect = 1

# Print all deadlocks to error log (useful for debugging)
innodb_print_all_deadlocks = 0

# ----------------------------------------------------------------------------
# InnoDB File Configuration
# ----------------------------------------------------------------------------

# File per table (recommended for InnoDB)
# Each table gets its own .ibd file, easier to manage
innodb_file_per_table = 1

# Autoextend increment for shared tablespace (MB)
innodb_autoextend_increment = 64

# ----------------------------------------------------------------------------
# InnoDB Optimization Features
# ----------------------------------------------------------------------------

# Adaptive hash index (automatically indexes hot data)
innodb_adaptive_hash_index = 1

# Change buffering (buffer secondary index changes)
# Options: all, none, inserts, deletes, changes, purges
innodb_change_buffering = all

# Adaptive flushing (dynamic checkpoint algorithm)
innodb_adaptive_flushing = 1

# Stats persistence (better query optimization)
innodb_stats_persistent = 1
innodb_stats_on_metadata = 0

# Doublewrite buffer (prevents corruption, slight performance cost)
# Keep enabled for data safety
innodb_doublewrite = 1

# File format (Barracuda supports compression, dynamic row format)
innodb_file_format = Barracuda

# Large prefix support (index key up to 3072 bytes)
innodb_large_prefix = 1

# Sort buffer size for creating indexes
innodb_sort_buffer_size = 8M

# ============================================================================
# MYISAM STORAGE ENGINE (Legacy Support)
# ============================================================================
# MyISAM is being phased out but needed for compatibility
# Keep these settings minimal since most tables will be InnoDB/Aria
# ============================================================================

# MyISAM key buffer (index cache)
key_buffer_size = 128M

# MyISAM sort buffer
myisam_sort_buffer_size = 64M

# MyISAM repair threads
myisam_repair_threads = 1

# ============================================================================
# ARIA STORAGE ENGINE (Logging Tables)
# ============================================================================
# Aria is crash-safe replacement for MyISAM, perfect for log tables
# ============================================================================

# Aria page cache buffer
aria_pagecache_buffer_size = 256M

# Aria log file size
aria_log_file_size = 256M

# Aria sort buffer
aria_sort_buffer_size = 64M

# ============================================================================
# QUERY CACHE (DISABLED)
# ============================================================================
# Query cache is deprecated in MariaDB 10.10+ and removed in 11.0+
# Not recommended for game servers due to high write frequency
# ============================================================================

query_cache_type = 0
query_cache_size = 0

# ============================================================================
# TABLE CACHE
# ============================================================================

# Open table cache (number of open tables)
# Formula: max_connections * (avg tables per query) * 2
table_open_cache = 4000

# Table definition cache (metadata cache)
table_definition_cache = 2000

# Open files limit
open_files_limit = 65535

# ============================================================================
# TEMPORARY TABLES
# ============================================================================

# Maximum size of in-memory temporary tables
tmp_table_size = 64M
max_heap_table_size = 64M

# ============================================================================
# SORT AND JOIN BUFFERS
# ============================================================================

# Sort buffer size (per connection, for ORDER BY, GROUP BY)
sort_buffer_size = 2M

# Read buffer size (for table scans)
read_buffer_size = 2M

# Read RND buffer size (for sorted reads)
read_rnd_buffer_size = 2M

# Join buffer size (for joins without indexes)
join_buffer_size = 2M

# ============================================================================
# BINARY LOGGING (Point-in-Time Recovery)
# ============================================================================
# Binary logs enable point-in-time recovery and replication
# Essential for disaster recovery
# ============================================================================

# Enable binary logging
log_bin = /var/lib/mysql/binlog/mysql-bin

# Binary log format (ROW is safest and most detailed)
# ROW = logs actual row changes, MIXED = ROW for unsafe statements, STATEMENT for safe
binlog_format = ROW

# Maximum binary log file size (rotate when reached)
max_binlog_size = 512M

# Days to keep binary logs before auto-deletion
expire_logs_days = 7

# Sync binary log to disk (1 = every commit, 0 = let OS decide, N = every N commits)
# 1 = safest but slower, 100 = good balance
sync_binlog = 1

# Binary log compression (MariaDB 10.2+, saves space)
log_bin_compress = 1
log_bin_compress_min_len = 256

# Binary log cache size (per transaction)
binlog_cache_size = 32K

# ============================================================================
# SLOW QUERY LOG
# ============================================================================
# Log slow queries for performance analysis
# ============================================================================

# Enable slow query log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log

# Queries taking longer than this will be logged (seconds)
long_query_time = 2

# Log queries not using indexes (helps identify missing indexes)
log_queries_not_using_indexes = 1

# Rate limit for queries not using indexes (per minute)
log_throttle_queries_not_using_indexes = 10

# Minimum examined rows to log
min_examined_row_limit = 100

# ============================================================================
# ERROR LOG
# ============================================================================

log_error = /var/log/mysql/error.log
log_warnings = 2

# ============================================================================
# GENERAL LOG (DISABLED - High Overhead)
# ============================================================================
# Only enable for debugging, logs ALL queries
# ============================================================================

general_log = 0
general_log_file = /var/log/mysql/general.log

# ============================================================================
# PERFORMANCE SCHEMA
# ============================================================================
# Performance schema provides detailed monitoring and diagnostics
# ============================================================================

# Enable performance schema
performance_schema = 1

# Performance schema memory limit
performance_schema_max_table_instances = 12500
performance_schema_max_table_handles = 4000

# ============================================================================
# REPLICATION SETTINGS (If Using Master-Slave)
# ============================================================================
# Uncomment and configure if setting up replication
# ============================================================================

# Master configuration
# server_id = 1
# log_bin = /var/lib/mysql/binlog/mysql-bin
# binlog_format = ROW

# Slave configuration
# server_id = 2
# relay_log = /var/lib/mysql/relay-log/mysql-relay
# relay_log_recovery = 1
# read_only = 1

# ============================================================================
# SECURITY SETTINGS
# ============================================================================

# Disable LOAD DATA LOCAL INFILE (security)
local_infile = 0

# Secure file privileges (restrict file operations to this directory)
# secure_file_priv = /var/lib/mysql-files

# Require secure connections for specific users (SSL/TLS)
# Uncomment if using SSL
# ssl_ca = /etc/mysql/ssl/ca-cert.pem
# ssl_cert = /etc/mysql/ssl/server-cert.pem
# ssl_key = /etc/mysql/ssl/server-key.pem

# ============================================================================
# OPTIMIZER SETTINGS
# ============================================================================

# Optimizer search depth (for complex queries)
optimizer_search_depth = 62

# Optimizer switch (enable/disable specific optimizations)
optimizer_switch = 'index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,subquery_materialization_cost_based=on,use_index_extensions=on'

# ============================================================================
# MARIADB-SPECIFIC FEATURES
# ============================================================================

# Histograms for better query optimization (MariaDB 10.0+)
histogram_size = 254
histogram_type = DOUBLE_PREC_HB

# Use stat tables for better query plans
use_stat_tables = preferably

# ============================================================================
# SAFETY AND LIMITS
# ============================================================================

# Maximum query result size
max_join_size = 4294967295

# Maximum sort length
max_sort_length = 1024

# Maximum query execution time (0 = no limit)
max_statement_time = 0

# ============================================================================
# TIMEZONE
# ============================================================================

# Default timezone (use system timezone or specify)
# default_time_zone = '+08:00'

# ============================================================================
# MAINTENANCE AND MONITORING
# ============================================================================

# Event scheduler (for automated maintenance tasks)
event_scheduler = ON

# ============================================================================
# END OF CONFIGURATION
# ============================================================================

[mysqldump]
quick
quote-names
max_allowed_packet = 64M

[mysqlhotcopy]
interactive-timeout

[mysqld_safe]
log-error = /var/log/mysql/error.log
pid-file = /var/run/mysqld/mysqld.pid
